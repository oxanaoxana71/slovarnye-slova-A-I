<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Тренажёр словарных слов — тренировка</title>
<style>
    :root{
        --bg:#0f1724;
        --card:#0b1220;
        --muted:#94a3b8;
        --accent:#06b6d4;
        --success:#10b981;
        --danger:#ef4444;
        --glass: rgba(255,255,255,0.03);
        --radius:12px;
        --max-width:980px;
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(180deg,#071024 0%, #081827 60%);
        color: #e6eef6;
        padding:24px;
        display:flex;
        justify-content:center;
    }
    .app{
        width:100%;
        max-width:var(--max-width);
    }
    header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
        margin-bottom:18px;
    }
    .brand{
        display:flex;
        gap:12px;
        align-items:center;
    }
    .logo{
        width:56px;height:56px;border-radius:12px;
        background:linear-gradient(135deg,var(--accent),#7c3aed);
        display:flex;align-items:center;justify-content:center;font-weight:700;
        font-size:20px;color:#021026;box-shadow:0 6px 20px rgba(10,10,10,0.6);
    }
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;align-items:center}
    button, .btn {
        background:var(--glass);
        color:inherit;border:1px solid rgba(255,255,255,0.04);
        padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#001219;border:0}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .card{
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border-radius:var(--radius); padding:18px; margin-bottom:14px; box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .layout{
        display:grid;grid-template-columns: 1fr 300px; gap:16px;
    }
    @media (max-width:900px){ .layout{grid-template-columns: 1fr} }
    .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{
        background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;font-weight:700;color:var(--muted);
    }
    .board{
        min-height:280px; display:flex;flex-direction:column; gap:12px; justify-content:center;
        align-items:stretch;
    }
    .question{
        font-size:20px;font-weight:700;
    }
    .variants{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media (max-width:450px){ .variants{grid-template-columns:1fr} }
    .variant{
        background:rgba(255,255,255,0.02); padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
        cursor:pointer; font-weight:600; text-align:center; transition:all .18s;
    }
    .variant:hover{ transform:translateY(-4px); box-shadow: 0 8px 30px rgba(2,6,23,0.5) }
    .variant.correct{background:rgba(16,185,129,0.12); border-color:rgba(16,185,129,0.4)}
    .variant.wrong{background:rgba(239,68,68,0.12); border-color:rgba(239,68,68,0.4)}
    .progress{
        height:12px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:6px;
    }
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7c3aed);width:0%}
    .sidebar{position:relative}
    .stat{display:flex;flex-direction:column;gap:6px}
    .stat .big{font-size:28px;font-weight:800}
    .small{color:var(--muted);font-size:13px}
    .error-list{margin-top:10px;max-height:260px;overflow:auto;padding-right:6px}
    .error-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;font-weight:600}
    footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}
    input[type="text"], input[type="password"], textarea {

width:100%; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:inherit;
    }
    .auth{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .hint{font-size:13px;color:var(--muted);margin-top:4px}
    .tiny{font-size:12px;color:var(--muted)}
    .top-actions{display:flex;gap:8px}
</style>
</head>
<body>
<div class="app">
    <header>
        <div class="brand">
            <div class="logo">ТС</div>
            <div>
                <h1>Тренажёр словарных слов</h1>
                <div class="sub">Практика орфографии — раунд: 30 слов • Репетитор для ошибок</div>
            </div>
        </div>

        <div class="controls">
            <div id="userArea" class="auth"></div>
        </div>
    </header>

    <div class="layout">
        <main>
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="meta">
                            <div class="badge" id="roundInfo">Раунд: —</div>
                            <div class="badge" id="qInfo">Вопрос: —</div>
                            <div class="badge" id="errorInfo">Ошибки: 0</div>
                        </div>
                        <div class="hint" id="userHint"></div>
                    </div>
                    <div class="top-actions">
                        <button class="btn" id="btnNew">Новая игра</button>
                        <button class="btn" id="btnErrors">Работа над ошибками</button>
                        <button class="btn" id="btnExport">Экспорт ошибок</button>
                        <label class="btn ghost" id="importLabel" title="Импорт JSON"><input type="file" id="fileImport" accept=".json" style="display:none">Импорт</label>
                    </div>
                </div>

                <div class="board" id="board">
                    <!-- Вопрос и варианты -->
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="card stat">
                <div class="small">Прогресс раунда</div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div class="big" id="progressBig">— / 30</div>
                    <div class="small" id="percent">0%</div>
                </div>
                <div class="progress"><i id="progressBar"></i></div>

                <div style="margin-top:14px;">
                    <div class="small">Текущие ошибки (пользователь)</div>
                    <div class="error-list" id="errorList"></div>
                    <div class="hint tiny">Нажми на ошибку чтобы пропустить к ней в "работе над ошибками"</div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="small">Настройки</div>
                <div style="margin-top:8px" class="tiny">
                    <label>Размер раунда:
                        <select id="roundSize">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30" selected>30</option>
                            <option value="50">50</option>
                        </select>
                    </label>
                </div>
                <div style="margin-top:8px" class="tiny">
                    <label><input type="checkbox" id="autoNext" checked> Авто-переход после ответа</label>
                </div>
            </div>
        </aside>
    </div>

    <footer class="card">
        <div class="small">Версия: 1.0 — Клиентская версия для размещения на GitHub Pages. Авторизация и прогресс хранятся локально в браузере.</div>
    </footer>
</div>

<script>
/* -----------------------------
   === НАСТРОЙКИ И ДАННЫЕ ===
   ----------------------------- */

*/
const WORDS = [
                ["абитуриент", "абетуриент", "обитуриент"] ,
                ["абонемент", "обонемент", "абанемент"] ,
                ["абрикосовый", "абрикосавый", "абрекосовый"] ,
                ["академия", "акодемия", "акадэмия"] },
                ["академический", "акодемический", "окемический"] ,
                ["аквамарин", "аквомарин", "акваморин"] ,
                ["акварель", "акворель", "акварэль"] ,
                ["аккомпанемент", "акомпанемент", "аккомпанимент"],
                ["аккомпанировать", "акомпанировать", "аккампанировать"] ,
                ["аккомпаниатор", "акомпаниатор", "аккомпанеатор"] ,
                ["аннотация", "анотация", "анатация"] ,
                ["антресоли", "антрисоли", "онтресоли"] ,
                ["апелляция", "апеляция", "аппеляция"] ,
                ["апеллировать", "апелировать", "аппелировать"] ,
                ["аплодировать", "оплодировать", "апладировать"] ,
                ["аплодисменты", "оплодисменты", "апладисменты"] ,
                ["аппаратура", "апаратура", "аппарратура"] ,
                ["аппетит", "апетит", "апеттит"],
                ["аромат", "арамат", "ароматт"],
                ["ароматный", "араматный", "ароматтный"],
                ["архитектор", "архетектор", "архитектр"],
                ["архитектура", "архетектура", "архитектурра"],
  ["асфальт", "осфальт", "асвальт"],
  ["асфальтировать", "осфальтировать", "асвальтировать"],
  ["атмосфера", "атмасфера", "отмосфера"],
  ["атмосферный", "атмасферный", "отмосферный"],
  ["аттракцион", "атракцион", "атрракцион"],
  ["аукцион", "аукцыон", "аукционн"],
  ["багаж", "богаж", "багаш"],
  ["багровый", "багрровый", "богровый"],
  ["багряный", "багрянный", "богряный"],
  ["бадминтон", "бадментон", "бадминтонн"],
  ["баланс", "баланц", "боланс"],
  ["балкон", "балконн", "болкон"],
  ["барельеф", "барильеф", "барелеф"],
  ["баскетбол", "боскетбол", "баскетболл"],
  ["бассейн", "басейн", "бассейен"],
  ["берёзовый", "берёзавый", "бирёзовый"],
  ["беречь", "биречь", "береч"],
  ["бирюзовый", "берюзовый", "биррюзовый"],
  ["богатство", "багатство", "богатсво"],
  ["богатырь", "багатырь", "богатыр"],
  ["брошюра", "брошура", "бращюра"],
  ["брошюровать", "брошуровать", "брашюровать"],
  ["бюллетень", "бюлетень", "бюлютень"],
  ["вакцина", "вакцына", "вокцина"],
  ["вакцинация", "вакцынация", "вокцинация"],
  ["вакцинировать", "вакцынировать", "вокцинировать"],
  ["вариант", "вареант", "вориант"],
  ["вариативный", "вареативный", "вориативный"],
  ["велосипед", "веласипед", "вилосипед"],
  ["велосипедный", "веласипедный", "вилосипедный"],
  ["вентилятор", "винтилятор", "винтелятор"],
  ["вермишель", "вермешель", "вирмишель"],
  ["вестибюль", "вистибюль", "вестебюль"],
  ["ветеран", "витеран", "ветерран"],
  ["винегрет", "венегрет", "винигрет"],
  ["виртуальный", "вертуальный", "виртуалльный"],
  ["виртуоз", "вертуоз", "виртуозз"],
  ["витраж", "ветраж", "витраш"],
  ["владелец", "владелетс", "влоделец"],
  ["возражать", "возрожать", "вазражать"],
  ["возражение", "возрожение", "вазражение"],
  ["вокзал", "вакзал", "воггзал"],
  ["вокзальный", "вакзальный", "вогзальный"],
  ["волейбол", "воллейбол", "валейбол"],
  ["воображать", "воабражать", "вооброжать"],
  ["воображение", "воабражение", "вооброжение"],
  ["воплотить", "ваплотить", "воплатить"],
  ["воплощать", "ваплощать", "воплащать"],
  ["впечатление", "впечетление", "впичатление"],
  ["выразительный", "вырозительный", "вырразительный"],
  ["выразить", "вырразить", "вырозить"],
  ["выражение", "вырражение", "вырожение"],
  ["газон", "гозон", "газонн"],
  ["галактика", "голактика", "галлактика"],
  ["галактический", "голактический", "галлактический"],
  ["галерея", "голерея", "галлерея"],
  ["гармония", "гормония", "гармонея"],
  ["гармоничный", "гормоничный", "гарманичный"],
  ["гарнизон", "гарнезон", "горнизон"],
  ["геологический", "геалогический", "гиологический"],
  ["герой", "гирой", "геррой"],
  ["героизм", "герроизм", "гироизм"],
  ["гипотеза", "гепотеза", "гипотиза"],
  ["гипотетический", "гепотетический", "гипотетичиский"],
  ["гормон", "гармон", "гормонн"],
  ["горячий", "гарячий", "горрячий"],
  ["горизонт", "горизонд", "гаризонт"],
  ["горизонтальный", "горезонтальный", "гаризонтальный"],
  ["грамматика", "граматика", "громматика"],
  ["грамматический", "граматический", "граммотический"],
  ["грамота", "грамата", "граммота"],
  ["грамотный", "граммотный", "граматный"],
  ["громадный", "грамадный", "громмадный"],
  ["громоздкий", "грамоздкий", "громмоздкий"],
  ["громоздить", "грамоздить", "громмоздить"],
  ["дебаты", "дибаты", "деббаты"],
  ["декларация", "деклорация", "диклорация"],
  ["декорация", "декорацыя", "декоррация"],
  ["декоративный", "декаративный", "декорративный"],
  ["деликатес", "диликатес", "делликатес"],
  ["деликатный", "диликатный", "делликатный"],
  ["демократ", "димократ", "демакрат"],
  ["демонстрировать", "димонстрировать", "деманстрировать"],
  ["демонстрация", "димонстрация", "деманстрация"],
  ["диалог", "деалог", "диолог"],
  ["диапазон", "деапазон", "диопазон"],
  ["динамика", "диннамика", "денамика"],
  ["дирижёр", "дерижёр", "дирижор"],
  ["дирижировать", "дерижировать", "дирежировать"],
  ["диспетчер", "диспечер", "деспетчер"],
  ["дистанция", "дистанцыя", "дестанция"],
  ["дистанционный", "дистанционый", "дестанционный"],
  ["дисциплина", "дисцеплина", "дисцыплина"],
  ["желание", "желанье", "жылание"],
  ["желать", "жылать", "жилать"],
  ["жираф", "жыраф", "жераф"],
  ["жокей", "жоккей", "жакей"],
  ["жонглёр", "жанглёр", "жонглёрр"],
  ["жюри", "жури", "жюрри"],
  ["знакомить", "знокомить", "знакоммить"],
  ["знаменитый", "зноменитый", "знамменитый"],
  ["знаменовать", "зноменовать", "знаминовать"],
  ["игнорировать", "игнориравать", "игнарировать"],
  ["идеал", "идиал", "идеалл"],
  ["идеализировать", "идиализировать", "идеалезировать"],
  ["идеалист", "идиалист", "идеолист"],
  ["иждивенец", "иждевенец", "иждивениц"],
  ["иллюзия", "илюзия", "иллюзья"],
  ["иллюзионист", "илюзионист", "иллюзеанист"],
  ["индивид", "индевид", "инндивид"],
  ["иней", "иний", "инней"],
  ["инженер", "инжинер", "инженерр"],
  ["инженерный", "инжинерный", "инженеррный"],
  ["инициатива", "иницыатива", "иницеатива"],
  ["инициативный", "иницыативный", "инециативный"],
  ["интеллект", "интелект", "интиллект"],
  ["интеллектуальный", "интелектуальный", "интиллектуальный"],
  ["интеллигент", "интелегент", "интилегент"],
  ["интеллигенция", "интелегенция", "интилигенция"],
  ["интерьер", "интэрьер", "интеръер"],
  ["исказить", "искозить", "изказить"],
  ["истинный", "истенный", "истиный"],
  ["кампания", "компания", "кампанийа"],
  ["каморка", "коморка", "каморрка"],
  ["канитель", "канетель", "конитель"],
  ["канонада", "кананада", "конанада"],
  ["канцелярия", "концелярия", "канцэлярия"],
  ["канцелярский", "концелярский", "канцылярский"],
  ["капюшон", "капишон", "капюшён"],
  ["кардинальный", "координальный", "кординальный"]
       
            ];



];

// НЕ УДАЛЯЙ: базовые ключи localStorage
const LS_USERS_KEY = 'ts_users_v1'; // хранит список пользователей
const LS_USER_PREFIX = 'ts_user_'; // ts_user_{username} => объект с прогрессом и ошибками

/* -----------------------------
   === УТИЛИТЫ ===
   ----------------------------- */
function qs(sel){return document.querySelector(sel)}
function qsa(sel){return Array.from(document.querySelectorAll(sel))}
function randInt(max){ return Math.floor(Math.random()*max) }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }

/* -----------------------------
   === АВТОРИЗАЦИЯ (локальная) ===
   Простая схема: при регистрации сохраняем username в LS_USERS_KEY
   и создаём объект ts_user_{username} = { errors:[], stats:{}, rounds:[] }
   ----------------------------- */
let currentUser = null; // {name: '...', data: {...}}
function saveUserDataToLS(username, data){
    localStorage.setItem(LS_USER_PREFIX + username, JSON.stringify(data))
    const users = JSON.parse(localStorage.getItem(LS_USERS_KEY) || "[]");
    if(!users.includes(username)){ users.push(username); localStorage.setItem(LS_USERS_KEY, JSON.stringify(users)) }
}
function loadUserDataFromLS(username){
    const raw = localStorage.getItem(LS_USER_PREFIX + username);
    if(!raw) return null;
    try{ return JSON.parse(raw) }catch(e){ return null }
}
function renderAuthArea(){
    const ua = qs('#userArea');
    ua.innerHTML = '';
    if(!currentUser){
        // show login / register form
        const inp = document.createElement('input'); inp.type='text'; inp.placeholder='имя пользователя'; inp.id='loginName';
        inp.style.padding='8px'; inp.style.borderRadius='8px'; inp.style.border='1px solid rgba(255,255,255,0.04)';
        const btnLogin = document.createElement('button'); btnLogin.textContent='Войти'; btnLogin.className='btn';
        const btnReg = document.createElement('button'); btnReg.textContent='Регистрация'; btnReg.className='btn ghost';
        ua.appendChild(inp); ua.appendChild(btnLogin); ua.appendChild(btnReg);

        btnLogin.addEventListener('click', ()=>{
            const name = inp.value.trim();
            if(!name){ alert('Введите имя пользователя'); return; }
            const data = loadUserDataFromLS(name);
            if(!data){ alert('Пользователь не найден. Зарегистрируйтесь.'); return; }
            currentUser = {name, data};
            onUserChanged();
        });
        btnReg.addEventListener('click', ()=>{
            const name = inp.value.trim();
            if(!name){ alert('Введите имя пользователя'); return; }
            let data = loadUserDataFromLS(name);
            if(data){
                if(!confirm('Пользователь с таким именем уже существует. Войти под ним?')) return;
            } else {
                data = { errors:[], stats:{ totalRounds:0, totalCorrect:0, totalWrong:0 }, rounds:[] };
                saveUserDataToLS(name, data);
            }
            currentUser = {name, data};
            onUserChanged();
        });

    } else {
        const span = document.createElement('div'); span.innerHTML = <div style="text-align:right"><div style="font-weight:800">${currentUser.name}</div><div class="tiny muted">пользователь</div></div>;
        const btnOut = document.createElement('button'); btnOut.textContent='Выйти'; btnOut.className='btn';
        ua.appendChild(span); ua.appendChild(btnOut);
        btnOut.addEventListener('click', ()=>{
            currentUser = null;
            renderAuthArea();
            updateUIAfterUserChange();
        });
    }
}

/* -----------------------------
   === ПЕРЕМЕННЫЕ И ЛОГИКА ИГРЫ ===
   ----------------------------- */
let roundWords = []; // массив ссылок на элемент WORDS
let roundSize = 30;
let idx = 0;
let totalWrong = 0;

Оксана, [01.12.2025 23:55]
let currentRoundMode = 'normal'; // normal | errors
let autoNext = true;

function getUserErrors(){
    return (currentUser && currentUser.data && Array.isArray(currentUser.data.errors)) ? currentUser.data.errors : [];
}
function setUserErrors(arr){
    if(!currentUser) return;
    currentUser.data.errors = arr;
    saveUserDataToLS(currentUser.name, currentUser.data);
}

/* Формируем раунд:
   - если mode === 'errors' — берем только ошибки (all or up to roundSize)
   - иначе: сначала берем все ошибки (если есть), затем дополняем случайными словами
*/
function pickRoundWords(mode='normal'){
    roundSize = parseInt(qs('#roundSize').value, 10);
    let set = [];
    const userErrors = getUserErrors();
    // convert stored errors (we save as strings) back to references in WORDS if possible
    // We'll store errors as the correct word string, so we can match.
    if(mode !== 'errors' && userErrors.length > 0){
        // add unique by correct word
        userErrors.forEach(wordCorrect => {
            const found = WORDS.find(w => w[0] === wordCorrect);
            if(found) set.push(found);
        });
    }
    if(mode === 'errors'){
        // all errors up to size
        const items = [];
        userErrors.forEach(wordCorrect => {
            const found = WORDS.find(w => w[0] === wordCorrect);
            if(found) items.push(found);
        });
        shuffle(items);
        return items.slice(0, roundSize);
    }
    // fill remaining
    const pool = WORDS.filter(w => !set.includes(w));
    shuffle(pool);
    while(set.length < roundSize && pool.length > 0){
        set.push(pool.shift());
    }
    shuffle(set);
    return set;
}

/* -----------------------------
   === ОТОБРАЖЕНИЕ ВОПРОСА ===
   ----------------------------- */
function renderBoard(){
    const board = qs('#board');
    board.innerHTML = '';
    if(idx >= roundWords.length){
        showRoundEnd();
        return;
    }
    const qNum = idx + 1;
    const qTotal = roundWords.length;

    qs('#roundInfo').textContent = Раунд: ${currentRoundMode === 'errors' ? 'Работа над ошибками' : 'Обычный'}
    qs('#qInfo').textContent = Вопрос: ${qNum} / ${qTotal}
    qs('#errorInfo').textContent = Ошибки: ${totalWrong}
    qs('#userHint').textContent = currentUser ? Пользователь: ${currentUser.name} : 'Войдите чтобы сохранять прогресс и ошибки';

    qs('#progressBig').textContent = ${qNum} / ${qTotal};
    const pct = Math.round((qNum-1)/qTotal*100);
    qs('#percent').textContent = ${pct}%;
    qs('#progressBar').style.width = ${pct}%;

    const cardQ = document.createElement('div');
    cardQ.className = 'question';
    cardQ.textContent = Выбери правописание слова:;
    board.appendChild(cardQ);

    const word = roundWords[idx];
    const original = word[0];
    const variants = [...word];
    shuffle(variants);

    const variantsWrap = document.createElement('div');
    variantsWrap.className = 'variants';
    variants.forEach(v => {
        const btn = document.createElement('div');
        btn.className = 'variant';
        btn.textContent = v;
        btn.dataset.val = v;
        btn.addEventListener('click', onSelectVariant);
        variantsWrap.appendChild(btn);
    });
    board.appendChild(variantsWrap);

    // small help
    const hint = document.createElement('div');
    hint.className = 'tiny muted';
    hint.style.marginTop='8px';
    hint.textContent = 'Правильный вариант в каждом наборе — первый элемент в массиве WORDS.';
    board.appendChild(hint);
}

/* Обработчик выбора варианта */
function onSelectVariant(e){
    const selected = e.currentTarget.dataset.val;
    const correct = roundWords[idx][0];
    const variantsEls = qsa('.variant');
    // блокируем клики
    variantsEls.forEach(el => el.style.pointerEvents='none');

    // помечаем
    variantsEls.forEach(el => {
        if(el.dataset.val === correct) el.classList.add('correct');
        if(el.dataset.val === selected && selected !== correct) el.classList.add('wrong');
    });

    if(selected !== correct){
        totalWrong++;

// сохраняем ошибку в профиле — храним по корректному слову
        if(currentUser){
            const errors = getUserErrors();
            if(!errors.includes(correct)){
                errors.push(correct);
                setUserErrors(errors);
                renderErrorList();
            }
        }
    } else {
        // если угадал — удаляем слово из ошибок если там было
        if(currentUser){
            const errors = getUserErrors().filter(w => w !== correct);
            setUserErrors(errors);
            renderErrorList();
        }
    }

    // статистика пользователя
    if(currentUser){
        currentUser.data.stats.totalCorrect = (currentUser.data.stats.totalCorrect||0) + (selected === correct ? 1 : 0);
        currentUser.data.stats.totalWrong = (currentUser.data.stats.totalWrong||0) + (selected !== correct ? 1 : 0);
        saveUserDataToLS(currentUser.name, currentUser.data);
    }

    const doNext = () => {
        idx++;
        renderBoard();
    };

    if(autoNext){
        setTimeout(doNext, 650);
    } else {
        // добавить кнопку "Дальше"
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Дальше';
        nextBtn.className = 'btn primary';
        nextBtn.style.marginTop = '12px';
        nextBtn.addEventListener('click', ()=>{
            doNext();
        });
        qs('#board').appendChild(nextBtn);
    }
}

/* Показываем итог раунда */
function showRoundEnd(){
    qs('#roundInfo').textContent = 'Раунд завершён';
    qs('#qInfo').textContent = Вопрос: ${roundWords.length} / ${roundWords.length};
    qs('#progressBig').textContent = ${roundWords.length} / ${roundWords.length};
    qs('#percent').textContent = '100%';
    qs('#progressBar').style.width = 100%;
    const board = qs('#board');
    board.innerHTML = '';

    const title = document.createElement('div'); title.className='question'; title.textContent = 'Раунд завершён — результат';
    board.appendChild(title);

    const res = document.createElement('div'); res.style.marginTop='10px';
    res.innerHTML = `<div class="small">Всего вопросов: <b>${roundWords.length}</b></div>
                     <div class="small">Ошибок в этом раунде: <b>${totalWrong}</b></div>`;
    board.appendChild(res);

    const again = document.createElement('div'); again.style.marginTop='12px';
    const btn1 = document.createElement('button'); btn1.className='btn primary'; btn1.textContent='Новая игра';
    const btn2 = document.createElement('button'); btn2.className='btn'; btn2.textContent='Работа над ошибками';
    again.appendChild(btn1); again.appendChild(btn2);
    board.appendChild(again);

    btn1.addEventListener('click', ()=> startGame('normal'));
    btn2.addEventListener('click', ()=> startGame('errors'));

    // сохраняем раунд в статистику
    if(currentUser){
        const st = currentUser.data.stats;
        st.totalRounds = (st.totalRounds||0) + 1;
        saveUserDataToLS(currentUser.name, currentUser.data);
    }
}

/* -----------------------------
   === UI: список ошибок в сайдбаре ===
   ----------------------------- */
function renderErrorList(){
    const wrap = qs('#errorList');
    wrap.innerHTML = '';
    const errors = getUserErrors();
    if(!errors || errors.length === 0){
        wrap.innerHTML = '<div class="tiny muted">Ошибок нет — отлично!</div>';
        return;
    }
    errors.forEach(wordCorrect => {
        const el = document.createElement('div');
        el.className = 'error-item';
        el.textContent = wordCorrect;
        el.title = 'Нажми чтобы пройти работу над этой ошибкой';
        el.addEventListener('click', ()=>{
            // запустим раунд только с этой ошибкой
            const found = WORDS.find(w => w[0] === wordCorrect);
            if(found){
                roundWords = [found];
                idx = 0;
                totalWrong = 0;
                currentRoundMode = 'errors';
                renderBoard();
            } else alert('Слово не найдено в WORDS.');
        })
        wrap.appendChild(el);
    })
}

/* -----------------------------
   === НАГРУЗКА / СБРОС ===
   ----------------------------- */
function startGame(mode='normal'){
    currentRoundMode = mode;
    roundWords = pickRoundWords(mode);
    idx = 0;
    totalWrong = 0;
    renderBoard();
}

function updateUIAfterUserChange(){
    renderAuthArea();
    renderErrorList();
}

/* -----------------------------
   === ИНИЦИАЛИЗАЦИЯ ЭЛЕМЕНТОВ ===
   ----------------------------- */
function setupHandlers(){
    qs('#btnNew').addEventListener('click', ()=> startGame('normal'));
    qs('#btnErrors').addEventListener('click', ()=> {
        if(!currentUser || getUserErrors().length===0){
            if(!currentUser) alert('Войдите, чтобы работать с вашими ошибками.');
            else alert('У вас пока нет ошибок — отлично!');
            return;
        }
        startGame('errors');
    });
    qs('#roundSize').addEventListener('change', ()=> {
        // ничего не делаем, возьмётся при старте
    });
    qs('#autoNext').addEventListener('change', (e)=> {
        autoNext = e.target.checked;
    });
    qs('#btnExport').addEventListener('click', ()=>{
        if(!currentUser){ alert('Войдите, чтобы экспортировать свои ошибки.'); return; }
        const data = { user: currentUser.name, errors: getUserErrors() };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = ${currentUser.name}_errors.json; a.click();
        URL.revokeObjectURL(url);
    });

    // import
    const fileInput = qs('#fileImport');
    fileInput.addEventListener('change', (ev)=>{
        const f = ev.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(e){
            try {
                const parsed = JSON.parse(e.target.result);
                if(parsed && Array.isArray(parsed.errors)){
                    if(!currentUser){ if(!confirm('Вы не вошли. Хотите импортировать ошибки в нового пользователя?')) return; }
                    if(!currentUser){
                        const name = prompt('Введите имя пользователя для сохранения импортированных ошибок:');
                        if(!name) return;
                        currentUser = { name, data: { errors: [], stats:{}, rounds: [] } };
                    }
                    // merge unique
                    const doMerge = Array.from(new Set([...(currentUser.data.errors||[]), ...parsed.errors]));
                    setUserErrors(doMerge);
                    alert('Ошибки импортированы');
                    renderErrorList();
                } else alert('Формат файла некорректен. Ожидается JSON с полем errors:[]');
            } catch(err){
                alert('Ошибка при чтении файла: ' + err.message);
            }
        }
        reader.readAsText(f);
        fileInput.value = '';
    });

    // render auth initially
    renderAuthArea();
    updateUIAfterUserChange();
}

/* -----------------------------
   === СТАРТ СКРИПТА ===
   ----------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
    // начальные настройки
    autoNext = qs('#autoNext').checked;
    setupHandlers();
    // стартовая пустая доска
    qs('#board').innerHTML = <div class="tiny muted">Нажмите "Новая игру" чтобы начать. Войдите чтобы сохранять прогресс и ошибки.</div>;
});
</script>
</body>
</html>
